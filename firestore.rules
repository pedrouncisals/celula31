rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // USUÁRIOS
    // ============================================
    // Usuários podem ler perfis de outros usuários (para exibir nome/foto)
    // Mas só podem editar seu próprio perfil
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // ============================================
    // SALAS (ROOMS) - Módulo Estudo Bíblico
    // ============================================
    match /rooms/{roomId} {
      // Qualquer usuário autenticado pode ler salas (para ver lista)
      allow read: if request.auth != null;
      // Qualquer usuário autenticado pode criar salas
      allow create: if request.auth != null;
      // Apenas o admin pode atualizar ou excluir a sala
      allow update, delete: if request.auth != null && 
        resource.data.adminId == request.auth.uid;
      
      // Membros da sala
      match /members/{memberId} {
        // Qualquer usuário autenticado pode ver membros
        allow read: if request.auth != null;
        // Qualquer usuário autenticado pode se adicionar como membro
        // Ou o admin pode adicionar/remover membros
        allow write: if request.auth != null;
      }
      
      // Capítulos da sala
      match /chapters/{chapterId} {
        // Apenas membros podem ler capítulos
        allow read: if request.auth != null && 
          exists(/databases/$(database)/documents/rooms/$(roomId)/members/$(request.auth.uid));
        // Apenas o admin pode criar/atualizar capítulos (para definir destaques)
        allow write: if request.auth != null && 
          resource.data.adminId == request.auth.uid;
      }
      
      // Resumos da sala
      match /summaries/{summaryId} {
        // Apenas membros podem ler resumos
        allow read: if request.auth != null && 
          exists(/databases/$(database)/documents/rooms/$(roomId)/members/$(request.auth.uid));
        // Apenas membros podem criar resumos, e devem ser o autor
        allow create: if request.auth != null && 
          exists(/databases/$(database)/documents/rooms/$(roomId)/members/$(request.auth.uid)) &&
          request.resource.data.authorId == request.auth.uid;
        // O autor pode editar/excluir seu próprio resumo
        // OU qualquer membro pode atualizar apenas os campos likes e likedBy (para curtidas)
        allow update: if request.auth != null && 
          exists(/databases/$(database)/documents/rooms/$(roomId)/members/$(request.auth.uid)) &&
          (
            // Autor pode atualizar qualquer campo
            resource.data.authorId == request.auth.uid ||
            // Qualquer membro pode atualizar apenas likes e likedBy
            (
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likedBy']) &&
              request.resource.data.authorId == resource.data.authorId &&
              request.resource.data.chapter == resource.data.chapter &&
              request.resource.data.verseBlock == resource.data.verseBlock
            )
          );
        // Apenas o autor pode excluir
        allow delete: if request.auth != null && 
          resource.data.authorId == request.auth.uid;
      }
      
      // Comentários da sala
      match /comments/{commentId} {
        // Apenas membros podem ler comentários
        allow read: if request.auth != null && 
          exists(/databases/$(database)/documents/rooms/$(roomId)/members/$(request.auth.uid));
        // Apenas membros podem criar comentários, e devem ser o autor
        allow create: if request.auth != null && 
          exists(/databases/$(database)/documents/rooms/$(roomId)/members/$(request.auth.uid)) &&
          request.resource.data.authorId == request.auth.uid;
        // Apenas o autor pode editar/excluir seu próprio comentário
        allow update, delete: if request.auth != null && 
          resource.data.authorId == request.auth.uid;
      }
    }
    
    // ============================================
    // SERMÕES - Módulo Criador de Sermões
    // ============================================
    match /sermons/{sermonId} {
      // Apenas o autor pode ler seus próprios sermões
      allow read: if request.auth != null && 
        resource.data.authorId == request.auth.uid;
      // Apenas usuários autenticados podem criar sermões
      // E devem ser o autor
      allow create: if request.auth != null && 
        request.resource.data.authorId == request.auth.uid;
      // Apenas o autor pode editar/excluir seus próprios sermões
      allow update, delete: if request.auth != null && 
        resource.data.authorId == request.auth.uid;
    }
  }
}

